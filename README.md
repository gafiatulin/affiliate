#affiliate

### –ú–∏–Ω–∏–ø—Ä–æ—Ç–æ—Ç–∏–ø —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –¥–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–î–∞–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø –ª–∏—à—å —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
* –ø—Ä–æ—Ç–æ—Ç–∏–ø —è–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º
* –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ —É –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤, –∞ –ª–∏—à—å –æ–¥–∏–Ω (–æ–Ω –∂–µ –∏ —è–≤–ª—è–µ—Ç—Å—è `id` –ø–∞—Ä—Ç–Ω–µ—Ä–∞).

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏
* `GET /signup?ref=xxx` ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–Ω–æ–ø–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
* `GET /signup/affiliate?ref=xxx`‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–Ω–æ–ø–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
* `GET /affiliate/xxx` ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ä—Ç–Ω–µ—Ä—É
* `POST /signup?ref=xxx` ‚Äî ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º `ref`
* `POST /signup/affiliate?ref=xxx` ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º `ref`

### –î–µ–π—Å—Ç–≤–∏—è —Å–æ—Ö—Ä–∞–Ω—è–º—ã–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `ref`
* –ü–æ—Å–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã `/signup` –∏–ª–∏ `/signup/affiliate`
* ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª –∫–ª–∏–µ–Ω—Ç–∞
* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

* [akka-http](http://doc.akka.io/docs/akka-stream-and-http-experimental/2.0.3/scala.html) ([Spray](http://spray.io)-based –≤–µ—Ä—Å–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±—Ä–∞–Ω—á–µ ‚Äî `affiliate-spray`)
* [PostgreSQL](http://www.postgresql.org)
* [Slick](http://slick.typesafe.com)

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–º –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ñ–∞–π–ª–µ [LoadTest.md](/LoadTest.md)

-----

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã

–í –ø—É–Ω–∫—Ç–∞—Ö 1-6 –ø—Ä–∏–≤–µ–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã. –í –ø—É–Ω–∫—Ç–µ 7 –ø—Ä–∏–≤–µ–¥–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.


###1. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

* –ü–∞—Ä—Ç–Ω–µ—Ä –Ω–∞–≥—Ä–∞–∂–¥–∞–µ—Ç—Å—è –∑–∞ –ø–æ–∫–∞–∑—ã (–≤—Å–µ/—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø—Ä–æ–¥–∞–∂–∏ –∏ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤. –ü–∞—Ä—Ç–Ω–µ—Ä –ê, –ø—Ä–∏–≤–ª–µ–∫—à–∏–π –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ B –∏ C, —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏–≤–µ–ª–∏ –í –∏ –°.
* –ü–∞—Ä—Ç–Ω–µ—Ä—ã –ø—Ä–∏–≤–æ–¥—è—Ç –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–∞–∫ –∏ –Ω–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤. –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º, –Ω–æ –≤ –æ–±—â–µ–º —Å–ª—É—á–∞–µ –ø–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º.

###2. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏

–ü–∞—Ä—Ç–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥, –≤ –≤–∏–¥–µ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –∫–æ–¥–∞. –î–ª—è —Å–ª—É—á–∞—è —Å—Å—ã–ª–∫–∏ –∫–æ–¥ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–Ω—É –∏–∑ —á–∞—Å—Ç–µ–π URL:
* `https://site.com/signup/xxxxxxxxx/`
* `https://site.com/signup?ref=xxxxxxxxx`
* `https://site.com/signup#xxxxxxxxx`

–ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî 2, –Ω–∞–∏–º–µ–Ω–µ–µ ‚Äî 3.

###3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞.
* –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞.
* –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–¥–æ–º.
* –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–¥–æ–º/–ø–∞—Ä—Ç–Ω–µ—Ä–æ–º.
* –†–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞/–∫–æ–¥–∞.

###4. –°–≤—è–∑–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

![Component Connections](https://s3.amazonaws.com/f.cl.ly/items/2V1s1T340a1N3c2B253A/1.png)

–ù–∞ —Ä–∏—Å—É–Ω–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è —Å—Ö–µ–º–∞ —Å–≤—è–∑–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ: —ç—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, –ª–∏–±–æ **Affiliate** –º–æ–∂–µ—Ç –±—ã—Ç—å –º–æ–¥—É–ª–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞.

–í –∫–∞—á–µ—Å—Ç–≤–µ **Affiliate Action Source** –∏ **Affiliate API Client** v–º–æ–∂–µ—Ç –≤—ã—Å—Ç—É–ø–∞—Ç—å –ª—é–±–∞—è —Å—É—â–Ω–æ—Å—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞:

* –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç (–Ω–∞–±–æ—Ä –µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
* —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
* —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å

–ë–æ–ª–µ–µ —Ç–æ–≥–æ, **Affiliate Action Source** –∏ **Affiliate API Client** –º–æ–≥—É—Ç —è–≤–ª—è—Ç—å—Å—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å—É—â–Ω–æ—Å—Ç—å—é.

–°–∏–º–≤–æ–ª **ùëì** –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ {`f`} ‚à© {`g`} ‚à© {`h`}, –≥–¥–µ `f`, `g` –∏ `h`:

```scala
f(T1<:Action, T2):Unit | ‚àÄ c:Code ‚àÉ x:(T <: T2), f(T):Code => c = f(x)
```
```scala
g(T3<:Query, Either[ID, Code]):T4 | ‚àÄ q:T3 ‚àÉ f(T3, Code):T4
```
```scala
h(T5):Either[ID, Code]
```

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ **ùëì**  –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –≤–∏–¥–µ –Ω–∞–±–æ—Ä–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ MVC, –∞–∫—Ç–æ—Ä–æ–≤ –∞–∫—Ç–æ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞–±–æ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–π, etc.

–ë–µ–∑—ã–º—è–Ω–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ –æ–±–æ–∑–Ω–∞—á–∞—é—Ç —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –ë–î –∏ —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ **log**, **get** –∏ **new** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ **Affiliate Action Source** –∏ **Affiliate API Client** –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–∑–æ–≤–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π, —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –∞–∫—Ç–æ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –ø–æ—Ç–æ–∫–∞–º–∏ (Stream), http-–∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –≤—ã–∑—ã–≤–∞—é—â–∏–π [–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å(sender)/–∏—Å—Ç–æ—á–Ω–∏–∫(source)/–∫–ª–∏–µ–Ω—Ç] –æ—Ç–≤–µ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–ª–∏ –Ω–µ—Ç.

* –°—Ç—Ä–µ–ª–∫–∞ **log** –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä—ã (–¥–µ–π—Å—Ç–≤–∏–µ, –æ–±—ä–µ–∫—Ç —Å—é—Ä—ä–µ–∫—Ç–∏–≤–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤) –∏, ¬´–≤—ã–∑—ã–≤–∞—è¬ª `f`, —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–¥–æ–º.
* **get** ‚Äî // ‚Äî (–∑–∞–ø—Ä–æ—Å, –∫–æ–¥/–ø–∞—Ä—Ç–Ω–µ—Ä) ‚Äî // ‚Äî `g` ‚Äî // ‚Äî –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–¥–æ–º/–ø–∞—Ä—Ç–Ω–µ—Ä–æ–º –∏ —Ä–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞/–∫–æ–¥–∞.
* **new** ‚Äî // ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–∞ ‚Äî // ‚Äî `h` ‚Äî // ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞.

###5. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è —Å—Ö–µ–º–∞ –ë–î

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–π –≥–∏–±–∫–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∞ —Ç–∞–∫–∂–µ –æ–±–ª–µ–≥—á–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º—ã –ë–î:

**affiliates:**

|**key**   |**type**  |
|:--------:|:--------:|
|`id`      |`String`  |
|`codes`   |`[String]`|
|`ref_code`|`String`  |

**codes:**

|**key**         |**type**                      |
|:--------------:|:----------------------------:|
|`code`          |`String`                      |
|`affiliate`     |`String`                      |
|`page_views`    |`[Timestamp]`                 |
|`registrations` |`[Timestamp]`                 |
|`actions_A`     |`[(Timestamp, ActionAParams)]`|
|...             | ...                          |

–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `codes` –ø–æ–ª—è—Ö `actions_A` –∏ —Ç–¥. –æ–±–æ–∑–Ω–∞—á–∞—é—Ç –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä `unique_page_views`, `sells`, `referrals_regs`, `referals_sells`, etc.

###6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤/–∫–æ–¥–æ–≤

–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º —É—Å–ª–æ–≤–∏–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —è–≤–ª—è–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –∫–æ–¥–æ–≤.

–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ—Å–ª–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å –≤ —Å–∏—Å—Ç–µ–º–µ, —Å–æ—Å—Ç–æ—è—â–µ–π –∏–∑ –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ **Affiliate** –∏ –µ–¥–∏–Ω–æ–π –ë–î.
–í–æ–∑–º–æ–∂–Ω—ã –¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞: –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ì–ü–°–ß (+ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ) –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î.

–í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, —Å–æ—Å—Ç–æ—è—â–µ–π –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä –ë–î-**Affiliate**, –≥–¥–µ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å–∏—Å—Ç–µ–º–∞ –æ—Å–ª–∞–±–ª–µ–Ω–Ω–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ (eventually consistent DB) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã.

–î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ª—é–±—ã–º –∏–∑ –≤—ã—à–µ—É–ø–æ–º—è–Ω—É—Ç—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–ª—É—á–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å (–∫–æ–Ω–∫–∞—Ç–µ–Ω–∏—Ä–æ–≤–∞—Ç—å, —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å A —Å —Å–æ–ª—å—é B) –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã. –í –∫–∞—á–µ—Å—Ç–≤–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω–Ω–µ–∫—Ç–∞ –ë–î –∏–ª–∏ MAC-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏–ª–∏ –∏—Ö —á–∞—Å—Ç—å (—Ö–µ—à).

###7. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –æ–¥–∏–Ω –∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

![Concrete Architecture](https://s3.amazonaws.com/f.cl.ly/items/3A1M0l282k0l0V0K2s33/2.png)

–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç  ‚Äî **Play2 Application**.

**Affiliate**  ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–µ–∫–æ–µ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ –∞–∫—Ç–æ—Ä–æ–≤ –≤ –∞–∫—Ç–æ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ).

**Affiliate Action Source** –∏ **Affiliate API Client** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã Play.

–§—É–Ω–∫—Ü–∏—é **Affiliate API** –≤—ã–ø–æ–ª–Ω—è–µ—Ç **Affiliate Managing Actor**.

**new** ‚Äî `ask` —Å–æ–æ–±—â–µ–Ω–∏—è `m1` —Ç–∏–ø–∞ `Create`. –ù–∞—Å–ª–µ–¥–Ω–∏–∫–∏ `Create`:

* `case object Affiliate`
* `case class CodeFor(affiliateID: String)`

**get** ‚Äî `ask` —Å–æ–æ–±—â–µ–Ω–∏—è `m2` —Ç–∏–ø–∞ `Query`. –ö–µ–π—Å-–∫–ª–∞—Å—Å—ã `Query`:
* `QueryForCode(code: String, with: Query)`
* `AggregateFor(affiliate: String, with: Query, codes: [String] = [])`

**log** ‚Äî `tell` —Å–æ–æ–±—â–µ–Ω–∏–π `m3` –∏–ª–∏ `m4` —Ç–∏–ø–∞ `Action`, –ö–µ–π—Å-–∫–ª–∞—Å—Å—ã `Action`:
* `ActionXBy(user: String)`
* `ActionXWith(code: String)`

–ì–¥–µ –≤–º–µ—Å—Ç–æ `ActionX` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:
`SellBy(user: String)` –∏–ª–∏ `RegistrationWith(code: String)`.

**ùëì** ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –∞–∫—Ç–æ—Ä–∞–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî —Å–æ–æ—Ç–≤–µ—Å—Ç–≤—É—é—â–∏–µ –∫–µ–π—Å—ã `receive` –∞–∫—Ç–æ—Ä–æ–≤.

–ê–±—Å—Ç—Ä–∞–≥–∏—Ä—É—è—Å—å –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ë–î –∏ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –∫ –Ω–∏–º, –ø–æ–ª–æ–∂–∏–º —á—Ç–æ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ë–î –º—ã –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∏–ø–∞ `Future[Option[T]]`


**Affiliate Managing Actor**
* –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ `Create` ‚Äî —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Future[Some(String)]`.
* –°–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ `Query` ¬´—Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç¬ª —É **Searching/Processing Actor** –∏ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (`pipeTo`) –æ—Ç–≤–µ—Ç–∞ –≤–æ–ø—Ä–æ—à–∞–≤—à–µ–º—É –∫–ª–∏–µ–Ω—Ç—É.
* –°–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ `ActionXWith` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç **Logging Actor**.
* –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–∏–ø–∞ `ActionXBy` –∏—â–µ—Ç `ref_code` –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ id –≤ —Ç–∞–±–ª–∏—Ü–µ `users`. –ï—Å–ª–∏ –∫–æ–¥ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ—Å—ã–ª–∞–µ—Ç **Logging Actor** —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `ActionXWith` —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º.

**Logging Actor** ‚Äî –¥–µ–ª–∞–µ—Ç `update` –ø–æ–ª—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.

**Searching/Processing Actor** ‚Äî –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –ø–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ `codes`, –≤ —Å–æ–æ—Ç–≤–µ—Å—Ç–≤–∏–∏ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º, –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–¥–æ–≤, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–ª–∞—Ç–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä—É. –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π (–∏–ª–∏ –¥—Ä—É–≥–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) –±–µ—Ä—É—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

##### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—É—Ç–µ–π —Ä–æ—É—Ç–µ—Ä–∞
–î–ª—è –ø—É—Ç–µ–π, –∫—É–¥–∞ –º—ã –∂–¥–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä `/signup`) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ —á–∞—Å—Ç–∏ URL —Å –∫–æ–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.

–í —ç—Ç–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ö–æ–¥—è—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä code: `Option[String]`, –Ω–∞ –Ω–µ–º –¥–µ–ª–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ç—á–∏–Ω–≥ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
```scala
affiliateManagingActor ! ControllerActionWith(code)
```
–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –¥–æ–±–∞–≤–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É Cookie (`ref_code=code`) –∏/–∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –æ—Ç–≤–µ—Ç–∞.

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º –ø—É—Ç–∏ (+ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã), –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –æ–∂–∏–¥–∞–µ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏—è —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º Cookie –∏ –ø—É—Ç–∏, –∫—É–¥–∞ –ø—Ä–∏–≤–æ–¥—è—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã.

##### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
–í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏—Ö –Ω–∞—Å –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å `ControllerAction`:

```scala
affiliateManagingActor ! ControllerActionBy(user)
```

##### –ù–æ–≤—ã–µ –ø—É—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—É—Ç–∏ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã) –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏ –ø–æ–∏—Å–∫–∞/–æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–æ–¥–∞/–ø–∞—Ä—Ç–Ω–µ—Ä–∞.
